#!/bin/bash

#
# Install addons to test and their dependencies.
#

set -ex

# Pre-install setuptools-odoo as an optimization. Without this,
# setuptools-odoo will be installed repeatedly for each addon in the repo
# which significantly slows down installation in repos with many addons.
# Disable the post versioning strategy as we don't need the exact versions
# and this also significantly speeds-up installation.
export SETUPTOOLS_ODOO_POST_VERSION_STRATEGY_OVERRIDE=none
pip install "setuptools-odoo @ git+https://github.com/acsone/setuptools-odoo"

# Install addons in current repo in editable mode, so coverage will see them.
odoo_short_version=$(echo $ODOO_VERSION | cut -d '.' -f 1)
touch test-requirements.txt
for addon in $(addons --addons-dir "${ADDONS_DIR}" --include "${INCLUDE}" --exclude "${EXCLUDE}" --separator " " list) ; do
    echo "-e file://${PWD}/setup/${addon}#egg=odoo${odoo_short_version}-addon-${addon}" >> test-requirements.txt
done
pip install -r test-requirements.txt
pip config list
pip list

# Install 'deb' external dependencies of all Odoo addons found in path.
DEBIAN_FRONTEND=noninteractive apt-get install -qq --no-install-recommends $(oca_list_external_dependencies deb)
